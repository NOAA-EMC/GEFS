#!/bin/sh
#PBS -N jgefs_chem_forecast_00
##PBS -o /gpfs/dell6/ptmp/Xianwu.Xue/o/gefs_hub_ecf/com/output/dev/20200509/jgefs_chem_forecast_00.%J
#PBS -j oe
#PBS -l place=vscatter,select=2:ncpus=128:mpiprocs=128
##PBS -n 240
##PBS -R span[ptile=40]
##PBS -R 'affinity[core(1)]'
#PBS -q dev
#PBS -l walltime=9:00:00
##PBS -l walltime=3:00:00
##PBS -L /bin/sh
#PBS -A GEFS-DEV
#PBS -l debug=true

set -x

cd $PBS_O_WORKDIR

#module purge

export model=gefs
# to get HOMEgefs
export EXPID=test_port2wcoss2_new
#export HOMEgefs=${HOMEgefs:-/lfs/h2/emc/ens/noscrub/Xianwu.Xue/gefs/$EXPID}
export HOMEgefs=${HOMEgefs:-"/lfs/h2/emc/ens/noscrub/common/git/sorc/gefs/gefs_port2wcoss2_common"}
export HOMEgfs=/lfs/h2/emc/ens/noscrub/common/git/sorc/gw/gw_port2wcoss2_common
export WORKDIR=/lfs/h2/emc/ptmp/Xianwu.Xue/o/$EXPID

. ${HOMEgefs}/versions/run.ver

module purge
module load envvar/$envvar_ver
module load PrgEnv-intel/$PrgEnv_intel_ver
module load craype/$craype_ver
module load intel/$intel_ver

module load cray-mpich/$cray_mpich_ver
module load cray-pals/$cray_pals_ver

module load prod_util/$prod_util_ver
module load prod_envir/$prod_envir_ver

module load netcdf/$netcdf_ver
module load hdf5/$hdf5_ver

#module load lsf/$lsf_ver
module load cfp/$cfp_ver
export USE_CFP=YES

module list

# EXPORT list here
ulimit -s unlimited
ulimit -a

export cyc=00
export PDY=20210824

export npert=2

export envir=${envir:-dev}
export RUN_ENVIR=${RUN_ENVIR:-dev}
export NET=${NET:-gefs}
export RUN=${RUN:-gefs}

export HOMEdata=/lfs/h1/ops
export COMPATH=$HOMEdata/canned/com/gfs:$HOMEdata/canned/com/cfs:${WORKDIR}/$envir/com/${NET}
export DCOMROOT=${HOMEdata}/canned/dcom

#===
export job=${job:-$PBS_JOBNAME}

export COMROOT=${WORKDIR}/$envir/com
export GESROOT=${WORKDIR}/nwges
export DATAROOT=${WORKDIR}/tmp

export SENDCOM=YES
export KEEPDATA=YES     # ecflow NO
export SENDECF=NO       # ecflow YES
export SENDDBN=NO       # ecflow YES
export SENDDBN_NTC=NO   # ecflow YES

#---
export RUNMEM=geaer

# If needed, uncomment below statements to overwrite the setting in lsf_common.sh
export layout_x_chem=6
export layout_y_chem=8 #6
#export WRITE_GROUP_chem=1
export WRTTASK_PER_GROUP_chem=42 #24

#export parallel_threads_chem=1
#export restart_interval_aer=12

export total_tasks=330 #240
#export taskspernode=40
export FORECAST_SEGMENT=hr
#export RERUN="YES"

#
#export ESMF_RUNTIME_PROFILE=ON
#export ESMF_RUNTIME_PROFILE_OUTPUT=SUMMARY
#module load esmf/8.1.0.beta_snapshot_26
#export print_memory_usage=".true." #".false."

export gefsmpexec="mpiexec -n $total_tasks" # -ppn 120"

export envir=prod
# CALL executable job script here
${HOMEgefs}/jobs/JGEFS_FORECAST
