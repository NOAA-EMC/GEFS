#!/bin/sh
#PBS -N jgefs_atmos_post_0_16d_00_c00
##PBS -o /gpfs/dell6/ptmp/Xianwu.Xue/o/gefs_hub_ecf/com/output/dev/20200509/jgefs_atmos_post_00.%J
#PBS -j oe
#PBS -l place=vscatter,select=1:ncpus=24:mem=40GB:mpiprocs=24
##PBS -l place=vscatter,select=1:ncpus=24:mem=500GB:mpiprocs=24
##PBS -l select=1:ncpus=24:mem=500GB
##PBS -n 12
##PBS -R span[ptile=12]
#PBS -q dev
#PBS -l walltime=1:30:00
#4:30:00
##PBS -L /bin/sh
#PBS -A GEN-T2O
#PBS -V
##PBS -W umask=022
#PBS -l debug=true

set -x

cd $PBS_O_WORKDIR

#module purge
export MEMBER=c00 #p02 #p01 #c00

export model=gefs
# to get HOMEgefs
f=lsf_common.sh
if [[ -f "$f" ]]; then
    echo "$f exists."
    source $f
elif [[ -f "../$f" ]]; then
    echo "../$f exists."
    source ../$f
elif [[ -f "../../$f" ]]; then
    echo "../../$f exists."
    source ../../$f
elif [[ -f "../../../$f" ]]; then
    echo "../../../$f exists."
    source ../../../$f
fi
. ${HOMEgefs}/versions/run.ver

module purge
module load envvar/$envvar_ver
module load PrgEnv-intel/$prgenv_intel_ver
module load craype/$craype_ver
module load intel/$intel_ver

module load cray-pals/$cray_pals_ver
module load cray-mpich/$cray_mpich_ver

module load prod_util/$prod_util_ver
module load prod_envir/$prod_envir_ver
module load grib_util/$grib_util_ver

#module load hdf5-parallel/1.10.6
#module load netcdf-hdf5parallel/4.7.4
module load libjpeg/$libjpeg_ver
module load wgrib2/$wgrib2_ver

module load netcdf/$netcdf_ver
module load hdf5/$hdf5_ver
#module load lsf/$lsf_ver
module load g2tmpl/$g2tmpl_ver
module load cfp/$cfp_ver

#module load curl/7.72.0
export USE_CFP=YES

module list

# EXPORT list here
ulimit -s unlimited
ulimit -a

f=lsf_common.sh
if [[ -f "$f" ]]; then
    echo "$f exists."
    source $f
elif [[ -f "../$f" ]]; then
    echo "../$f exists."
    source ../$f
elif [[ -f "../../$f" ]]; then
    echo "../../$f exists."
    source ../../$f
elif [[ -f "../../../$f" ]]; then
    echo "../../../$f exists."
    source ../../../$f
fi

export RUNMEM=ge${MEMBER} #$MEMBER

export total_tasks=24
#export taskspernode=24
export FORECAST_SEGMENT=hr

export OMP_NUM_THREADS=1

export gefsmpexec="mpiexec -n $total_tasks" #96 -ppn 48"
#"mpiexec -n $total_tasks -ppn 6"
##mpiexec -ppn 48 -n 96
#"mpiexec -n $total_tasks"
#mpirun -n $total_tasks"

export envir=prod
# CALL executable job script here
${HOMEgefs}/jobs/JGEFS_ATMOS_POST
