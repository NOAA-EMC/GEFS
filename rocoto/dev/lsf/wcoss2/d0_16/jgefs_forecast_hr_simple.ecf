#!/bin/sh
#PBS -N jgefs_forecast_0_16d_00_c00
##PBS -o /gpfs/dell6/ptmp/Xianwu.Xue/o/gefs_hub_ecf/com/output/dev/20200509/jgefs_forecast_00.%J
#PBS -j oe
#PBS -l place=vscatter,select=3:ncpus=128:mpiprocs=128
#PBS -q dev
#PBS -l walltime=10:30:00
##PBS -L /bin/sh
#PBS -A GEN-T2O

set -x

cd $PBS_O_WORKDIR

#module purge
export MEMBER=c00 #p02 #p01 #c00

export model=gefs
# to get HOMEgefs
export EXPID=test_port2wcoss2_new
export HOMEgefs=${HOMEgefs:-"/lfs/h2/emc/ens/noscrub/common/git/sorc/gefs/gefs_port2wcoss2_common"}
export HOMEgfs=/lfs/h2/emc/ens/noscrub/common/git/sorc/gw/gw_port2wcoss2_common
export WORKDIR=/lfs/h2/emc/ptmp/Xianwu.Xue/o/$EXPID

. ${HOMEgefs}/versions/run.ver

module purge
module load envvar/$envvar_ver
module load PrgEnv-intel/$prgenv_intel_ver
module load craype/$craype_ver
module load intel/$intel_ver

module load cray-mpich/$cray_mpich_ver
module load cray-pals/$cray_pals_ver

module load prod_util/$prod_util_ver
module load prod_envir/$prod_envir_ver

module load netcdf/$netcdf_ver
module load hdf5/$hdf5_ver
#module load lsf/$lsf_ver
module load cfp/$cfp_ver
export USE_CFP=YES

module list

# EXPORT list here
ulimit -s unlimited
ulimit -a

export cyc=00
export PDY=20210824

export npert=2

export envir=${envir:-dev}
export RUN_ENVIR=${RUN_ENVIR:-dev}
export NET=${NET:-gefs}
export RUN=${RUN:-gefs}

export HOMEdata=/lfs/h1/ops
export COMPATH=$HOMEdata/canned/com/gfs:$HOMEdata/canned/com/cfs:${WORKDIR}/$envir/com/${NET}
export DCOMROOT=${HOMEdata}/canned/dcom

#===
export job=${job:-$PBS_JOBNAME}

export COMROOT=${WORKDIR}/$envir/com
export GESROOT=${WORKDIR}/nwges
export DATAROOT=${WORKDIR}/tmp

export SENDCOM=YES
export KEEPDATA=YES     # ecflow NO
export SENDECF=NO       # ecflow YES
export SENDDBN=NO       # ecflow YES
export SENDDBN_NTC=NO   # ecflow YES


#---
export RUNMEM=ge${MEMBER} #$MEMBER

#----
export layout_x=6
export layout_y=6
export WRITE_GROUP=1
export WRTTASK_PER_GROUP=24
export parallel_threads=1

export npe_wav=144 #120
export coupling_interval_sec=3600

export cplwav=".true."

#---
export ESMF_RUNTIME_PROFILE=ON
export ESMF_RUNTIME_PROFILE_OUTPUT=SUMMARY
module load esmf/8.1.0.beta_snapshot_26

export total_tasks=$((layout_x * layout_y * 6 + WRTTASK_PER_GROUP * WRITE_GROUP + npe_wav)) #384
#export taskspernode=40
export FORECAST_SEGMENT=hr
#export RERUN="YES"

export gefsmpexec="mpiexec -n $total_tasks"

export envir=prod
# CALL executable job script here
${HOMEgefs}/jobs/JGEFS_FORECAST
